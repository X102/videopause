<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Phát Media và Tra Cứu Phụ Đề</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Tùy chỉnh thanh cuộn */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        /* Hiệu ứng từ trong phụ đề */
        .subtitle-word {
            cursor: pointer;
            transition: color 0.2s, background-color 0.2s;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .subtitle-word:hover {
            background-color: #4a5568;
            color: #f7fafc;
        }
        /* Style cho layout chính */
        html, body {
            height: 100%;
            overflow: hidden; /* Ngăn cuộn trang chính */
        }
        #control-panel {
            overflow-y: auto; /* Cho phép cuộn bảng điều khiển */
        }
        #resizer {
            flex-shrink: 0; /* Ngăn thanh kéo co lại */
        }
        #main-content {
            min-width: 0; /* Cho phép phần media co lại */
        }
        #media-wrapper {
            flex: 1; /* Đảm bảo wrapper lấp đầy không gian còn lại */
            min-height: 0; /* Cần thiết cho flexbox hoạt động đúng trong mọi trường hợp */
        }
        /* CSS cho media để luôn vừa vặn */
        #mediaPlayer {
            /* Luôn giữ tỷ lệ khung hình và nằm gọn trong vùng chứa */
            object-fit: contain; 
        }

        /* --- Responsive Layout Logic --- */
        /* On large screens (lg), create a fixed, non-scrolling layout */
        @media (min-width: 1024px) {
            html, body {
                height: 100%;
                overflow: hidden;
            }
            body {
                display: flex;
                flex-direction: column;
            }
            .container-wrapper {
                flex-grow: 1;
                min-height: 0;
            }
            #main-container {
                height: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans leading-normal tracking-normal flex flex-col h-screen">

    <header class="text-center py-2 flex-shrink-0">
        <h1 class="text-2xl font-bold text-white">Học Ngoại Ngữ Qua Media</h1>
    </header>

    <div class="container-wrapper container mx-auto px-4 lg:px-8 pb-4">
        <div id="main-container" class="flex flex-col lg:flex-row h-full">
            
            <!-- Bảng điều khiển -->
            <aside id="control-panel" class="bg-gray-800 p-6 rounded-lg shadow-lg flex-shrink-0 lg:w-1/3 mb-8 lg:mb-0" style="min-width: 300px; max-width: 50vw;">
                <!-- Giới thiệu và Hướng dẫn -->
                <div class="mb-6 p-3 bg-gray-900 border border-blue-500/50 rounded-lg text-gray-300 text-sm">
                    <h2 class="text-lg font-bold mb-2 text-blue-300"><i class="fas fa-info-circle mr-2"></i>Hướng dẫn</h2>
                    <ul class="list-disc list-inside space-y-1">
                        <li><b>Bước 1:</b> Tải media (video/audio) và file phụ đề (.srt).</li>
                        <li><b>Bước 2:</b> Chọn đúng ngôn ngữ của phụ đề.</li>
                        <li><b>Bước 3:</b> Nhấn vào 1 từ hoặc kéo chọn cụm từ để tra cứu.</li>
                    </ul>
                    <p class="mt-2">
                        <i class="fas fa-magic-wand-sparkles mr-1 text-yellow-400"></i>
                        <a href="https://colab.research.google.com/drive/1itmzYafvZ5zzhcPT8cnbbFvpLOiH5wzI?usp=sharing" target="_blank" class="font-bold text-blue-400 hover:underline">Tạo Sub tự động tại đây</a>.
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block mb-2 font-bold text-sm" for="mediaUrl">1. Tải Media (Video/Audio)</label>
                    <input type="text" id="mediaUrl" placeholder="Dán link media (MP4, MP3,...)" class="w-full p-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <span class="text-center block my-2 text-gray-500 text-xs">hoặc</span>
                    <input type="file" id="mediaFile" accept="video/*, audio/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                </div>

                <div class="mb-4">
                    <label class="block mb-2 font-bold text-sm" for="srtFile">2. Tải File Phụ Đề (.srt)</label>
                    <input type="file" id="srtFile" accept=".srt" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-700">
                </div>

                <div class="mb-6">
                    <label for="languageSelect" class="block mb-2 font-bold text-sm">3. Chọn Ngôn Ngữ Phụ Đề</label>
                    <select id="languageSelect" class="w-full p-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <option value="en-US">Tiếng Anh (English)</option>
                        <option value="fr-FR">Tiếng Pháp (Français)</option>
                        <option value="de-DE">Tiếng Đức (Deutsch)</option>
                        <option value="es-ES">Tiếng Tây Ban Nha (Español)</option>
                        <option value="pt-PT">Tiếng Bồ Đào Nha (Português)</option>
                        <option value="it-IT">Tiếng Italia (Italiano)</option>
                        <option value="ru-RU">Tiếng Nga (Русский)</option>
                        <option value="cs-CZ">Tiếng Séc (Čeština)</option>
                        <option value="no-NO">Tiếng Na Uy (Norsk)</option>
                        <option value="zh-CN">Tiếng Trung (中文)</option>
                        <option value="ja-JP">Tiếng Nhật (日本語)</option>
                        <option value="ko-KR">Tiếng Hàn (한국어)</option>
                        <option value="lo-LA">Tiếng Lào (ລາວ)</option>
                        <option value="km-KH">Tiếng Khmer (ខ្មែរ)</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label for="geminiApiKey" class="block mb-2 font-bold text-sm">4. Gemini API Key (Tùy chọn)</label>
                     <p class="text-xs text-gray-500 mb-2">Lấy API Key của bạn tại <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 hover:underline">Google AI Studio</a>.</p>
                    <div class="flex gap-2">
                        <input type="password" id="geminiApiKey" placeholder="Nhập API Key của bạn" class="w-full p-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <button id="saveApiKeyBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Lưu</button>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-xl font-semibold mb-3 border-b-2 border-gray-700 pb-2">Lịch Sử Tra Cứu</h3>
                    <div id="history" class="h-48 overflow-y-auto bg-gray-900 p-3 rounded">
                        <p class="text-gray-500 italic">Chưa có từ nào được tra...</p>
                    </div>
                </div>
            </aside>
            
            <!-- Thanh kéo thay đổi kích thước -->
            <div id="resizer" class="hidden lg:block w-2 cursor-col-resize bg-gray-700 hover:bg-blue-600 transition-colors rounded-full mx-1"></div>

            <!-- Khu vực media và phụ đề -->
            <main id="main-content" class="lg:flex-1 flex flex-col p-0 lg:pl-2 h-full">
                <!-- Vùng chứa media, tự động co giãn -->
                <div id="media-wrapper" class="bg-black rounded-lg shadow-lg overflow-hidden w-full flex items-center justify-center">
                    <video id="mediaPlayer" class="max-w-full max-h-full" controls></video>
                </div>
                <!-- Nút điều khiển Tua media -->
                <div id="media-controls" class="flex items-center justify-center gap-4 py-2 flex-shrink-0">
                    <button id="rewindBtn" class="text-gray-400 hover:text-white text-2xl p-2" title="Tua lại 10 giây">
                        <i class="fas fa-backward"></i>
                    </button>
                    <button id="forwardBtn" class="text-gray-400 hover:text-white text-2xl p-2" title="Tua tới 10 giây">
                        <i class="fas fa-forward"></i>
                    </button>
                </div>
                <!-- Vùng chứa phụ đề -->
                <div id="subtitleContainer" class="p-4 bg-gray-800 rounded-lg text-center w-full flex-shrink-0 h-45">
                    <div id="prevSubtitle" class="text-gray-500 text-base sm:text-lg font-mono opacity-60 min-h-12"></div>
                    <div id="currentSubtitle" class="text-gray-200 text-xl sm:text-xl font-mono h-16">Phụ đề sẽ hiển thị ở đây...</div>
                    <div id="nextSubtitle" class="text-gray-500 text-base sm:text-lg font-mono opacity-60 h-12"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal tra cứu từ -->
    <div id="dictionaryModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-2xl text-white relative max-h-[95vh] flex flex-col border border-gray-600">
             <div class="flex items-center justify-between p-4 bg-gray-700 rounded-t-lg">
                <div class="flex items-center">
                    <h2 class="text-2xl font-bold">Tra cứu: "<span id="lookupWord" class="text-blue-400"></span>"</h2>
                    <button id="pronounceBtn" class="ml-4 p-2 bg-blue-600 hover:bg-blue-700 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"><i class="fas fa-volume-up"></i></button>
                </div>
                <button id="closeModal" class="text-3xl text-gray-500 hover:text-white">&times;</button>
            </div>
            <div id="modalContent" class="p-6 space-y-4 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        const mediaPlayer = document.getElementById('mediaPlayer');
        const mediaUrlInput = document.getElementById('mediaUrl');
        const mediaFileInput = document.getElementById('mediaFile');
        const srtFileInput = document.getElementById('srtFile');
        const subtitleContainer = document.getElementById('subtitleContainer');
        const prevSubtitleDiv = document.getElementById('prevSubtitle');
        const currentSubtitleDiv = document.getElementById('currentSubtitle');
        const nextSubtitleDiv = document.getElementById('nextSubtitle');
        const languageSelect = document.getElementById('languageSelect');
        const historyContainer = document.getElementById('history');
        const modal = document.getElementById('dictionaryModal');
        const closeModalBtn = document.getElementById('closeModal');
        const lookupWordSpan = document.getElementById('lookupWord');
        const pronounceBtn = document.getElementById('pronounceBtn');
        const modalContent = document.getElementById('modalContent');
        const geminiApiKeyInput = document.getElementById('geminiApiKey');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const rewindBtn = document.getElementById('rewindBtn');
        const forwardBtn = document.getElementById('forwardBtn');

        let subtitles = [];
        let savedWords = new Set();
        let currentSubtitleIndex = -1;
        let wasMediaPlaying = false;

        function parseSRT(srtText) {
            const normalizedText = srtText.replace(/\r\n/g, '\n');
            const pattern = /(\d+)\n([\d:,]+)\s-->\s([\d:,]+)\n([\s\S]*?(?=\n{2,}|$))/g;
            const subs = [];
            let match;
            while ((match = pattern.exec(normalizedText)) !== null) {
                subs.push({
                    id: parseInt(match[1], 10),
                    startTime: srtTimeToSeconds(match[2]),
                    endTime: srtTimeToSeconds(match[3]),
                    text: match[4].replace(/\n/g, ' ').trim()
                });
            }
            return subs;
        }

        function srtTimeToSeconds(timeStr) {
            const parts = timeStr.split(/[:,]/);
            return parseInt(parts[0], 10) * 3600 +
                   parseInt(parts[1], 10) * 60 +
                   parseInt(parts[2], 10) +
                   parseInt(parts[3], 10) / 1000;
        }
        
        function updateSubtitle() {
            const currentTime = mediaPlayer.currentTime;
            let foundSubIndex = -1;

            for (let i = 0; i < subtitles.length; i++) {
                if (currentTime >= subtitles[i].startTime && currentTime <= subtitles[i].endTime) {
                    foundSubIndex = i;
                    break;
                }
            }

            if (foundSubIndex !== currentSubtitleIndex) {
                 currentSubtitleIndex = foundSubIndex;
                 displaySubtitleContext();
            }
        }

        function displaySubtitleContext() {
            if (currentSubtitleIndex === -1) {
                makeInteractive(prevSubtitleDiv, '');
                makeInteractive(currentSubtitleDiv, '<p class="text-gray-500">.....</p>');
                makeInteractive(nextSubtitleDiv, '');
                return;
            }
            
            const prevText = (currentSubtitleIndex > 0) ? subtitles[currentSubtitleIndex - 1].text : '';
            const currentText = subtitles[currentSubtitleIndex].text;
            const nextText = (currentSubtitleIndex < subtitles.length - 1) ? subtitles[currentSubtitleIndex + 1].text : '';

            makeInteractive(prevSubtitleDiv, prevText);
            makeInteractive(currentSubtitleDiv, currentText);
            makeInteractive(nextSubtitleDiv, nextText);
        }

        function makeInteractive(element, text) {
            element.innerHTML = '';
             if (!text || text.startsWith('<p')) {
                element.innerHTML = text || '';
                return;
            }

            const lang = languageSelect.value;
            let parts;

            if (lang === 'zh-CN' || lang === 'ja-JP') {
                parts = text.split('');
            } else {
                parts = text.split(/(\s+)/);
            }

            parts.forEach(part => {
                if (part.trim() !== '') {
                    const wordSpan = document.createElement('span');
                    wordSpan.textContent = part;
                    wordSpan.className = 'subtitle-word';
                    element.appendChild(wordSpan);
                } else {
                    element.appendChild(document.createTextNode(part));
                }
            });
        }
        
        function handleWordClick(rawWord) {
            wasMediaPlaying = !mediaPlayer.paused;
            mediaPlayer.pause();
            
            const word = rawWord.trim().replace(/[.,!?;:"“”]/g, '').toLowerCase();
            if (!word) return;
            showDictionaryModal(word);
            saveWordToHistory(word);
        }

        function showDictionaryModal(word) {
            const lang = languageSelect.value;
            const langName = languageSelect.options[languageSelect.selectedIndex].text;
            const encodedWord = encodeURIComponent(word);

            lookupWordSpan.textContent = word;
            pronounceBtn.onclick = () => {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = lang;
                utterance.onerror = (event) => {
                    console.error('SpeechSynthesis Error:', event.error);
                    alert(`Lỗi phát âm: Không thể phát âm từ này. Vui lòng kiểm tra xem trình duyệt của bạn có hỗ trợ và đã cài đặt gói giọng nói cho "${langName}" chưa. Lỗi: ${event.error}`);
                };
                window.speechSynthesis.speak(utterance);
            };
            
            const youglishLangMap = {
                'en-US': 'english', 'ru-RU': 'russian', 'zh-CN': 'chinese',
                'fr-FR': 'french', 'de-DE': 'german', 'ja-JP': 'japanese',
                'ko-KR': 'korean', 'it-IT': 'italian', 'pt-PT': 'portuguese',
                'es-ES': 'spanish'
            };
            const youglishLang = youglishLangMap[lang];
            let youglishLinkHTML = '';
            if (youglishLang) {
                const youglishLink = `https://youglish.com/pronounce/${encodedWord}/${youglishLang}`;
                youglishLinkHTML = `<a href="${youglishLink}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fab fa-youtube mr-2 text-red-500"></i> Mở YouGlish (Phát âm trong ngữ cảnh)</a>`;
            }

            const googleTranslateLangMap = {
                'en-US': 'en', 'ru-RU': 'ru', 'zh-CN': 'zh-CN', 'fr-FR': 'fr',
                'de-DE': 'de', 'ja-JP': 'ja', 'ko-KR': 'ko', 'it-IT': 'it',
                'pt-PT': 'pt', 'es-ES': 'es', 'cs-CZ': 'cs', 'no-NO': 'no',
                'km-KH': 'km', 'lo-LA': 'lo'
            };
            const googleLangCode = googleTranslateLangMap[lang] || lang.split('-')[0];

            modalContent.innerHTML = `
                <div>
                    <h3 class="font-bold text-lg mb-2 text-blue-300">Tra cứu nhanh</h3>
                    <div class="space-y-2">
                        <a href="https://translate.google.com/?sl=${googleLangCode}&tl=vi&text=${encodedWord}&op=translate" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-language mr-2 text-blue-400"></i> Mở Google Dịch (Việt)</a>
                        ${youglishLinkHTML}
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg text-purple-300">Tra cứu AI (Gemini)</h3>
                        <button id="copyGeminiBtn" title="Sao chép nội dung" class="p-2 text-gray-400 hover:text-white"><i class="fas fa-copy"></i></button>
                    </div>
                    <button id="geminiQueryBtn" class="w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-robot mr-2"></i> Lấy thông tin (Trọng âm, ví dụ, ngữ pháp)
                    </button>
                    <div id="geminiResult" class="mt-2 p-3 bg-gray-900 rounded text-gray-300 whitespace-pre-wrap min-h-[50px]"></div>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-2 text-yellow-300">Từ điển & liên kết khác</h3>
                    <div id="externalLinks" class="space-y-2"></div>
                </div>`;
            
            document.getElementById('geminiQueryBtn').addEventListener('click', () => queryGemini(word, langName));
            document.getElementById('copyGeminiBtn').addEventListener('click', copyGeminiResult);

            const externalLinksContainer = document.getElementById('externalLinks');
            
            const vtudienLangMap = {
                'en-US': 'anh-viet', 'ru-RU': 'nga-viet', 'zh-CN': 'trung-viet',
                'fr-FR': 'phap-viet', 'de-DE': 'duc-viet', 'ja-JP': 'nhat-viet',
                'ko-KR': 'han-viet', 'it-IT': 'italia-viet', 'cs-CZ': 'sec-viet',
                'es-ES': 'taybannha-viet', 'pt-PT': 'bodaonha-viet', 'no-NO': 'nauy-viet',
                'km-KH': 'khmer-viet', 'lo-LA': 'lao-viet'
            };
            const vtudienSlug = vtudienLangMap[lang] || 'anh-viet';
            let links = `<a href="https://vtudien.com/${vtudienSlug}/dictionary/nghia-cua-tu-${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-book mr-2"></i> Tra VTuDien</a>`;

            const secondDictMap = {
                'en-US': `<a href="https://dictionary.cambridge.org/dictionary/english-vietnamese/${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-graduation-cap mr-2"></i> Tra Cambridge Dictionary</a>`,
                'ru-RU': `<a href="https://ru.wiktionary.org/wiki/${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-atlas mr-2"></i> Tra Wiktionary (Nga)</a>`,
                'zh-CN': `<a href="https://hanzii.net/search/word/${encodedWord}?hl=vi" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-pen-fancy mr-2"></i> Tra Hanzii Dict</a>`,
                'fr-FR': `<a href="https://www.larousse.fr/dictionnaires/francais/${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-atlas mr-2"></i> Tra Larousse (Pháp)</a>`,
                'de-DE': `<a href="https://www.duden.de/suchen/dudenonline/${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-atlas mr-2"></i> Tra Duden (Đức)</a>`,
                'ja-JP': `<a href="https://jisho.org/search/${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-torii-gate mr-2"></i> Tra Jisho (Nhật)</a>`,
                'ko-KR': `<a href="https://ko.dict.naver.com/#/search?query=${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-book-open mr-2"></i> Tra Naver Dict (Hàn)</a>`,
                'it-IT': `<a href="https://www.collinsdictionary.com/dictionary/italian-english/${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-atlas mr-2"></i> Tra Collins (Ý)</a>`,
                'cs-CZ': `<a href="https://slovnik.seznam.cz/preklad/cesky_anglicky/${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-atlas mr-2"></i> Tra Seznam (Séc)</a>`,
                'es-ES': `<a href="https://www.spanishdict.com/translate/${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-book-open mr-2"></i> Tra SpanishDict</a>`,
                'pt-PT': `<a href="https://www.linguee.com/portuguese-english/search?source=auto&query=${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-atlas mr-2"></i> Tra Linguee (Bồ Đào Nha)</a>`,
                'no-NO': `<a href="https://ordbokene.no/bm/search?q=${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-atlas mr-2"></i> Tra Ordbøkene (Na Uy)</a>`,
                'km-KH': `<a href="https://en.wiktionary.org/wiki/${encodedWord}#Khmer" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-atlas mr-2"></i> Tra Wiktionary (Khmer)</a>`,
                'lo-LA': `<a href="https://en.wiktionary.org/wiki/${encodedWord}#Lao" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fas fa-atlas mr-2"></i> Tra Wiktionary (Lao)</a>`
            };
            links += secondDictMap[lang] || '';

            links += `<a href="https://www.google.com/search?q=${encodedWord}" target="_blank" class="block w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded transition-colors"><i class="fab fa-google mr-2"></i> Tra Google Search</a>`;
            externalLinksContainer.innerHTML = links;
            modal.classList.remove('hidden');
        }

        async function queryGemini(word, langName) {
            const apiKey = localStorage.getItem('geminiApiKey');
            const geminiResultContainer = document.getElementById('geminiResult');
            const geminiQueryBtn = document.getElementById('geminiQueryBtn');

            if (!apiKey) {
                geminiResultContainer.innerHTML = `<p class="text-red-400">Vui lòng nhập và lưu Gemini API Key ở bảng điều khiển.</p>`;
                return;
            }

            geminiQueryBtn.disabled = true;
            geminiResultContainer.innerHTML = `<p class="italic">Đang hỏi Gemini...</p>`;

            const prompt = `Phân tích chi tiết về từ "${word}" trong ${langName}. Cung cấp các thông tin sau theo định dạng Markdown:\n- **Trọng âm:** (Ghi rõ âm tiết nhấn trọng âm)\n- **Nghĩa:** (Ghi ngắn gọn các nghĩa của từ)\n- **Ví dụ:** (Cung cấp 2-3 câu ví dụ có cả bản gốc và bản dịch tiếng Việt)\n- **Ngữ pháp:** (Loại từ, cách dùng cơ bản, các lưu ý nếu có)`;
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                geminiResultContainer.innerText = text;

            } catch (error) {
                console.error("Gemini API error:", error);
                geminiResultContainer.innerHTML = `<p class="text-red-400">Đã xảy ra lỗi: ${error.message}</p>`;
            } finally {
                geminiQueryBtn.disabled = false;
            }
        }

        function copyGeminiResult() {
            const geminiResultContainer = document.getElementById('geminiResult');
            const textToCopy = geminiResultContainer.innerText;
            const copyButton = document.getElementById('copyGeminiBtn');

            if (textToCopy && !textToCopy.includes('Đang hỏi Gemini...')) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalIcon = copyButton.innerHTML;
                    copyButton.innerHTML = `<i class="fas fa-check text-green-500"></i>`;
                    setTimeout(() => {
                        copyButton.innerHTML = originalIcon;
                    }, 2000);
                }).catch(err => {
                    console.error('Không thể sao chép: ', err);
                    alert('Sao chép thất bại!');
                });
            }
        }
        
        function saveWordToHistory(word) {
            if (!savedWords.has(word)) {
                savedWords.add(word);
                updateHistoryUI();
            }
        }

        function updateHistoryUI() {
            if (savedWords.size === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500 italic">Chưa có từ nào được tra...</p>';
                return;
            }
            historyContainer.innerHTML = '';
            const wordList = document.createElement('div');
            wordList.className = 'flex flex-wrap gap-2';
            savedWords.forEach(word => {
                const wordTag = document.createElement('span');
                wordTag.textContent = word;
                wordTag.className = 'bg-blue-600 text-white text-sm font-semibold px-2.5 py-1 rounded-full cursor-pointer hover:bg-blue-700';
                wordTag.onclick = () => handleWordClick(word);
                wordList.appendChild(wordTag);
            });
            historyContainer.appendChild(wordList);
        }

        function loadApiKey() {
            const savedKey = localStorage.getItem('geminiApiKey');
            if (savedKey) geminiApiKeyInput.value = savedKey;
        }

        function saveApiKey() {
            const key = geminiApiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('geminiApiKey', key);
                alert('Đã lưu Gemini API Key!');
            } else {
                localStorage.removeItem('geminiApiKey');
                alert('Đã xóa Gemini API Key!');
            }
        }
        
        function closeModal() {
            modal.classList.add('hidden');
            modalContent.innerHTML = ''; 
            if (wasMediaPlaying) {
                mediaPlayer.play();
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKey();
            initResizer();
        });

        saveApiKeyBtn.addEventListener('click', saveApiKey);
        
        mediaUrlInput.addEventListener('change', () => {
            const url = mediaUrlInput.value.trim();
            if (url) { mediaPlayer.src = url; mediaFileInput.value = ''; }
        });

        mediaFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const fileURL = URL.createObjectURL(file);
                mediaPlayer.src = fileURL;
                mediaUrlInput.value = '';
            }
        });

        srtFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    subtitles = parseSRT(e.target.result);
                    if (subtitles.length > 0) {
                        alert(`Đã tải và xử lý thành công ${subtitles.length} dòng phụ đề.`);
                    } else {
                        alert('Lỗi: Không thể đọc được file phụ đề. Vui lòng kiểm tra lại định dạng file .srt.');
                    }
                    currentSubtitleIndex = -1;
                };
                reader.readAsText(file, 'UTF-8');
            }
        });

        mediaPlayer.addEventListener('timeupdate', updateSubtitle);
        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });

        rewindBtn.addEventListener('click', () => {
            mediaPlayer.currentTime = Math.max(0, mediaPlayer.currentTime - 10);
        });

        forwardBtn.addEventListener('click', () => {
            if (mediaPlayer.duration) {
                mediaPlayer.currentTime = Math.min(mediaPlayer.duration, mediaPlayer.currentTime + 10);
            }
        });

        subtitleContainer.addEventListener('mouseup', (event) => {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText) {
                handleWordClick(selectedText);
                selection.removeAllRanges(); // Bỏ chọn sau khi tra
            } else if (event.target.classList.contains('subtitle-word')) {
                // Handle single click if no text was selected
                handleWordClick(event.target.textContent);
            }
        });


        // --- Resizer Logic ---
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const controlPanel = document.getElementById('control-panel');
            const mainContainer = document.getElementById('main-container');

            const savedWidth = localStorage.getItem('sidebarWidth');
            if (savedWidth) {
                controlPanel.style.width = savedWidth;
            }

            let x = 0;
            let sidebarWidth = 0;

            const mouseDownHandler = (e) => {
                x = e.clientX;
                sidebarWidth = controlPanel.getBoundingClientRect().width;

                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
                
                document.body.style.userSelect = 'none';
                document.body.style.pointerEvents = 'none';
            };

            const mouseMoveHandler = (e) => {
                const dx = e.clientX - x;
                const newSidebarWidth = sidebarWidth + dx;
                
                const minWidth = 300;
                const maxWidth = mainContainer.clientWidth - 400;

                if (newSidebarWidth > minWidth && newSidebarWidth < maxWidth) {
                    controlPanel.style.width = `${newSidebarWidth}px`;
                }
            };

            const mouseUpHandler = () => {
                localStorage.setItem('sidebarWidth', controlPanel.style.width);

                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                
                document.body.style.userSelect = '';
                document.body.style.pointerEvents = '';
            };

            resizer.addEventListener('mousedown', mouseDownHandler);
        }
    </script>
</body>
</html>

